<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Checkout — UltraVGamer</title>
<style>
  body{background:#04060c;color:#eaf2ff;font-family:system-ui;padding:32px}
  .container{max-width:760px;margin:0 auto}
  h1{color:#3ea6ff;text-align:center;margin-bottom:18px}
  .cart-list{background:#0b0b0f;padding:16px;border-radius:10px;margin-bottom:16px}
  .cart-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.03)}
  .total{font-weight:700;text-align:right;margin:12px 0}
  .methods{display:flex;gap:12px;margin-bottom:12px}
  .method{padding:10px;border-radius:8px;background:#111;cursor:pointer;flex:1;text-align:center}
  .method.active{outline:2px solid #3ea6ff}
  form{background:#0b0b0f;padding:16px;border-radius:10px}
  label{display:block;margin-top:8px;font-size:0.9rem}
  input{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit}
  .pay{margin-top:12px;padding:12px;border-radius:8px;border:none;background:#3ea6ff;color:#000;font-weight:700;cursor:pointer;width:100%}
  .note{opacity:.9;margin-top:8px;font-size:.9rem}
  .small{font-size:.9rem;opacity:.8}
  .hidden{display:none}
  .success{background:linear-gradient(135deg,#3ee0a6,#3ea6ff);color:#000;padding:12px;border-radius:10px;text-align:center}
</style>
</head>
<body>
<div class="container">
  <h1>Checkout</h1>
  <div class="cart-list" id="cart-list">
    <!-- cart items rendered here -->
  </div>
  <div class="total" id="total">Total: $0.00</div>

  <div class="methods small">Choose payment method</div>
  <div style="margin-bottom:12px">
    <label class="small">Coupon code: <input id="coupon-input" placeholder="Enter coupon code" style="padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit"></label>
    <button id="apply-coupon" class="pay" style="display:inline-block;margin-left:8px;padding:8px 12px;width:auto;">Apply</button>
    <div id="coupon-message" class="small" style="margin-top:8px"></div>
  </div>

  <div id="paypal-area">
    <div style="background:#111;padding:16px;border-radius:10px;text-align:center">
      <p class="note">Complete the purchase using PayPal.</p>
      <div id="paypal-button-container"></div>
    </div>
  </div>

  <div id="result" class="hidden"></div>
  <div id="result-message" style="margin-top:12px"></div>
  <div style="margin-top:18px;text-align:center"><a href="buy.html" class="small">Return to shop</a></div>
</div>

<script>
// Read cart from localStorage
const stored = localStorage.getItem('cart');
const cart = stored ? JSON.parse(stored) : [];
const cartList = document.getElementById('cart-list');
const totalEl = document.getElementById('total');
const result = document.getElementById('result');

// Coupons configuration: change names/values here
const COUPONS = {
  ULTRA50: { type: 'percent', value: 50 },
  NIGGAROBUX: { type: 'percent', value: 100 }
};

// track applied coupon
let appliedCoupon = null;

function renderCart(){
  cartList.innerHTML = '';
  if(!cart.length){ cartList.innerHTML = '<div class="small">Cart is empty.</div>'; totalEl.textContent = 'Total: $0.00'; return; }
  cart.forEach(i=>{
    const div = document.createElement('div'); div.className='cart-item';
    div.innerHTML = `<div>${i.name}</div><div>$${i.price.toFixed(2)}</div>`;
    cartList.appendChild(div);
  });
  const subtotal = cart.reduce((s,i)=>s+i.price,0);
  const discounted = applyCouponToAmount(subtotal, appliedCoupon);
  totalEl.textContent = 'Total: $' + discounted.toFixed(2) + (appliedCoupon ? `  (code: ${appliedCoupon})` : '');
}

function applyCouponToAmount(amount, coupon){
  if(!coupon) return amount;
  const code = coupon.toUpperCase();
    const cfg = COUPONS[code];
    if(!cfg) return amount;
    if(cfg.type === 'percent'){
      return amount * (1 - (cfg.value/100));
    }
    return amount;
}

renderCart();

// Payment elements
const paypalArea = document.getElementById('paypal-area');
const couponInput = document.getElementById('coupon-input');
const applyCouponBtn = document.getElementById('apply-coupon');
const couponMessage = document.getElementById('coupon-message');

// --- PayPal Buttons integration (load on page load) ---
async function loadPayPalButtons(){
  try{
    // CLIENT-SIDE PayPal Buttons (no server required for testing)
    // Replace CLIENT_ID below with your sandbox client id if you prefer a different one.
    const CLIENT_ID = 'AVsANnxtgSUyn8HnmFYpYkhPeoJyqlYJHNNmw9vDc04FAIpXCo_5EjwgFB78sXaqB07BnucWDJXyQPBd';
    // load SDK dynamically
    await new Promise((resolve, reject)=>{
      const s = document.createElement('script');
      s.src = `https://www.paypal.com/sdk/js?client-id=${CLIENT_ID}&currency=USD`;
      s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
    });

    function getTotal(){
      const subtotal = cart.reduce((s,i)=>s + (i.price||0), 0);
      const discounted = applyCouponToAmount(subtotal, appliedCoupon);
      return discounted.toFixed(2);
    }

    const paypalButtons = window.paypal.Buttons({
       style: { shape: 'rect', layout: 'vertical', color: 'blue', label: 'checkout' },
       createOrder(data, actions) {
            // create order on the client using the cart total
            const value = getTotal();
            // If total is $0.00 (free), don't call PayPal — complete instantly
            if (value === '0.00'){
              // generate code and record order then redirect to success
              const code = (function(len=15){const chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789';let s='';for(let i=0;i<len;i++)s+=chars[Math.floor(Math.random()*chars.length)];return s;})();
              // save purchase details
              try{ localStorage.setItem('last_purchase_order', JSON.stringify({ items: cart, total: value })); }catch(e){}
              localStorage.setItem('last_purchase_code', code);
              localStorage.removeItem('cart');
              setTimeout(()=>{ window.location.href = 'success.html'; }, 300);
              // return a rejected promise to prevent PayPal from proceeding
              return Promise.reject(new Error('Free purchase completed'));
            }
            return actions.order.create({ purchase_units: [{ amount: { currency_code: 'USD', value } }] });
        },
         onApprove(data, actions) {
          console.log('PayPal onApprove called', data);
          return actions.order.capture().then(function(details){
            try{
              console.log('Capture details', details);
              const transaction = details?.purchase_units?.[0]?.payments?.captures?.[0] || {};
              try{ resultMessage(`Transaction ${transaction.status || 'COMPLETED'}: ${transaction.id || details.id}<br><br>See console for details`); }catch(e){}
              // generate and save code then redirect to success page
              const code = (function(len=15){const chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789';let s='';for(let i=0;i<len;i++)s+=chars[Math.floor(Math.random()*chars.length)];return s;})();
              // save purchase details (use discounted total)
              try{ localStorage.setItem('last_purchase_order', JSON.stringify({ items: cart, total: getTotal() })); }catch(e){}
              try{ localStorage.setItem('last_purchase_code', code); }catch(e){}
              try{ localStorage.removeItem('cart'); }catch(e){}
              // short delay to show message then redirect
              setTimeout(()=>{ window.location.href = 'success.html'; }, 800);
            }catch(err){
              console.error('Error handling capture result', err);
              // still attempt to save basic info and redirect
              try{ const code = (function(len=15){const chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789';let s='';for(let i=0;i<len;i++)s+=chars[Math.floor(Math.random()*chars.length)];return s;})(); localStorage.setItem('last_purchase_code', code); localStorage.setItem('last_purchase_order', JSON.stringify({ items: cart, total: getTotal() })); localStorage.removeItem('cart'); }catch(_){ }
              setTimeout(()=>{ window.location.href = 'success.html'; }, 800);
            }
          }).catch(function(err){
            console.error('Capture failed', err);
            resultMessage('Capture failed: ' + (err && err.message ? err.message : err));
            // try to still save order info if possible
            try{ const code = (function(len=15){const chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789';let s='';for(let i=0;i<len;i++)s+=chars[Math.floor(Math.random()*chars.length)];return s;})(); localStorage.setItem('last_purchase_code', code); localStorage.setItem('last_purchase_order', JSON.stringify({ items: cart, total: getTotal() })); localStorage.removeItem('cart'); }catch(_){ }
            // redirect anyway so user can see next steps
            setTimeout(()=>{ window.location.href = 'success.html'; }, 1200);
          });
        }
    });
    paypalButtons.render('#paypal-button-container').catch(e=>{
      console.error('Render failed', e); resultMessage('PayPal Buttons failed to render: '+(e && e.message ? e.message : e));
    });
    // onError handler at Buttons-level: provide user feedback
    if(typeof paypalButtons.error === 'function'){
      try{ paypalButtons.error = function(err){ console.error('PayPal error', err); resultMessage('PayPal error: '+(err && err.message?err.message:err)); }; }catch(_){ /* ignore */ }
    }
  }catch(e){
    console.error('PayPal Buttons failed to load', e);
    resultMessage('Could not load PayPal Buttons: ' + e);
  }
}

// Create container and load buttons
(function(){
  const c = document.createElement('div'); c.id='paypal-button-container'; c.style.marginTop='12px';
  const area = document.getElementById('paypal-area');
  // insert buttons into the PayPal area so they are visible when PayPal method is selected
  area.insertBefore(c, area.firstChild);
  loadPayPalButtons();
})();

// Coupon apply handler
applyCouponBtn.addEventListener('click', ()=>{
  const code = (couponInput.value||'').trim().toUpperCase();
  if(!code){ appliedCoupon = null; couponMessage.textContent = 'No coupon applied'; renderCart(); return; }
  const cfg = COUPONS[code];
  if(cfg){
    appliedCoupon = code;
    couponMessage.textContent = `Applied ${code}`;
    renderCart();
    // If it's a 100% off coupon, complete immediately
    if(cfg.type === 'percent' && cfg.value === 100){
      const codeStr = (function(len=15){const chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789';let s='';for(let i=0;i<len;i++)s+=chars[Math.floor(Math.random()*chars.length)];return s;})();
      localStorage.setItem('last_purchase_code', codeStr);
      localStorage.removeItem('cart');
      setTimeout(()=>{ window.location.href = 'success.html'; }, 200);
    }
  }else{
    couponMessage.textContent = 'Invalid coupon';
  }
});
</script>
</body>
</html>